["do",

 ["def", "mut",
  ["fn", ["init"],
   ["array", "init"]]],

 ["def", "deref",
  ["fn", ["mut"],
   ["get", "mut", 0]]],

 ["def", "reset!",
  ["fn", ["mut", "val"],
   ["set!", "mut", 0, "val"]]],

 ["def", "empty?",
  ["fn", ["xs"],
   ["cond",
    ["null?", "xs"],
    "true",

    ["=", ["size", "xs"], 0],
    "true",

    "else",
    "false"]]],

 ["def", "zipmap",
  ["fn", ["xs", "ys", "acc"],
   ["cond",
    ["empty?", "xs"],
    "acc",

    "else",
    ["let", ["x", ["get", "xs", 0],
             "y", ["get", "ys", 0]],
     ["zipmap",
      ["rest", "xs"],
      ["rest", "ys"],
      ["concat", "acc", ["array", "x", "y"]]]]]]],

 ["def", "mget",
  ["fn", ["m", "key"],
   ["cond",
    ["empty?", "m"],
    "null",

    "else",
    ["let", ["m0", ["get", "m", 0],
             "m1", ["get", "m", 1]],
     ["cond",
      ["=", "m0", "key"],
      "m1",

      "else",
      ["mget", ["slice", "m", 2], "key"]]]]]],

 ["def", "mput",
  ["fn", ["m", "key", "val"],
   ["concat", ["array", "key", "val"],
    "m"]]],

 ["def", "env-lookup",
  ["fn", ["env", "key"],
   ["let", ["val", ["mget", ["deref", "env"], "key"]],
    ["cond",
     ["null?", "val"],
     ["let", ["parent", ["mget", ["deref", "env"], ["str", "__PARENT__"]]],
      ["cond",
       ["null?", "parent"],
       "null",

       "else",
       ["env-lookup", "parent", "key"]]],

     "else",
     "val"]]]],

 ["def", "env-extend!",
  ["fn", ["env", "bindings"],
   ["mut", ["mput", "bindings", ["str", "__PARENT__"], "env"]]]],

 ["def", "rest",
  ["fn", ["xs"],
   ["slice", "xs", 1]]],

 ["def", "last",
  ["fn", ["xs"],
   ["get", ["slice", "xs", -1], 0]]],

 ["def", "map",
  ["fn", ["f", "xs"],
   ["cond",
    ["empty?", "xs"],
    "xs",

    "else",
    ["let", ["x", ["get", "xs", 0],
             "rem", ["rest", "xs"]],
     ["concat", ["array", ["f", "x"]],
      ["map", "f", "rem"]]]]]],

 ["def", "apply+",
  ["fn", ["f", "args", "env"],
   ["cond",
    ["array?", "f"],
    ["let", ["f-args", ["mget", "f", ["str", "args"]],
             "f-body", ["mget", "f", ["str", "body"]],
             "f-bindings", ["zipmap", "f-args", "args", ["array"]],
             "f-env",  ["env-extend!", "env", "f-bindings"]],
     ["walk", "f-body", "f-env"]],

    "else",
    ["apply", "f", "args"]]]],

 ["def", "fresh-env",
  ["fn", [],
   ["mut",
    ["array",
     ["str", "__PARENT__"], "null",

     ["str", "null"],     "null",
     ["str", "true"],     "true",
     ["str", "false"],    "false",
     ["str", "else"],     "true",
     ["str", "cmd-args"], ["rest", "cmd-args"],

     ["str", "="], "=",
     ["str", "<"], "<",
     ["str", ">"], ">",
     ["str", "+"], "+",
     ["str", "-"], "-",
     ["str", "*"], "*",
     ["str", "/"], "/",

     ["str", "null?"],   "null?",
     ["str", "number?"], "number?",
     ["str", "string?"], "string?",
     ["str", "array?"],  "array?",

     ["str", "array"],  "array",
     ["str", "get"],    "get",
     ["str", "set!"],   "set!",
     ["str", "slice"],  "slice",
     ["str", "size"],   "size",
     ["str", "concat"], "concat",

     ["str", "not"],   "not",
     ["str", "apply"], "apply+",

     ["str", "print"],      "print",
     ["str", "read-file"],  "read-file",
     ["str", "parse-json"], "parse-json"]]]],

 ["def", "walk",
  ["fn", ["expr", "env"],
   ["cond",
    ["number?", "expr"],
    "expr",

    ["string?", "expr"],
    ["env-lookup", "env", "expr"],

    ["array?", "expr"],
    ["let", ["op-expr",    ["get", "expr", 0],
             "args-exprs", ["rest", "expr"]],
     ["cond",
      ["=", "op-expr", ["str", "do"]],
      ["last",
       ["map", ["fn", ["expr"],
                ["walk", "expr", "env"]],
        "args-exprs"]],

      ["=", "op-expr", ["str", "def"]],
      ["let", ["var",     ["get", "args-exprs", 0],
               "val-exp", ["get", "args-exprs", 1],
               "val",     ["walk", "val-exp", "env"]],
       ["reset!", "env", ["mput", ["deref", "env"], "var", "val"]]],

      ["=", "op-expr", ["str", "fn"]],
      ["let", ["args", ["get", "args-exprs", 0],
               "body", ["get", "args-exprs", 1]],
       ["array",
        ["str", "args"], "args",
        ["str", "body"], "body"]],

      ["=", "op-expr", ["str", "str"]],
      ["get", "args-exprs", 0],

      ["=", "op-expr", ["str", "let"]],
      ["let", ["bindings", ["get", "args-exprs", 0],
               "body", ["get", "args-exprs", 1]],
       ["cond",
        ["empty?", "bindings"],
        ["walk", "body", "env"],

        "else",
        ["let", ["var",     ["get", "bindings", 0],
                 "val-exp", ["get", "bindings", 1],
                 "val",     ["walk", "val-exp", "env"],
                 "let-env", ["env-extend!", "env", ["array", "var", "val"]],
                 "remaining-bindings", ["slice", "bindings", 2]],
         ["walk", ["array", ["str", "let"], "remaining-bindings", "body"], "let-env"]]]],

      ["=", "op-expr", ["str", "cond"]],
      ["cond",
       ["empty?", "args-exprs"],
       "null",

       "else",
       ["let", ["cond0-exp", ["get", "args-exprs", 0],
                "then0-exp", ["get", "args-exprs", 1],
                "remaining", ["slice", "args-exprs", 2]],
        ["cond",
         ["walk", "cond0-exp", "env"],
         ["walk", "then0-exp", "env"],

         "else",
         ["walk", ["concat", ["array", ["str", "cond"]], "remaining"], "env"]]]],

      "else",
      ["let", ["f",    ["walk", "op-expr", "env"],
               "args", ["map", ["fn", ["exp"],
                                ["walk", "exp", "env"]],
                        "args-exprs"]],
       ["apply+", "f", "args", "env"]]]]]]],

 ["let", ["file", ["get", "cmd-args", 0],
          "json", ["read-file", "file"],
          "code", ["parse-json", "json"],
          "env",  ["fresh-env"]],
  ["walk", "code", "env"]]]
